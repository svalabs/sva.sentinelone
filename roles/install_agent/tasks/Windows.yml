---
- name: "Windows: Include Windows.yml vars"
  ansible.builtin.include_vars:
    file: Windows.yml

- name: "Windows: Remove windows defender feature on Windows Server OS"
  ansible.windows.win_feature:
    name: Windows-Defender
    state: absent
  register: win_feature_remove
  when: ansible_os_name | search('Windows Server')

- name: "Windows: Check if SentinelOne is already installed"
  ansible.windows.win_service:
    name: SentinelAgent
  register: sentinelagent_service

- name: "Block: Windows: Install SentinelOne agent"
  when: not sentinelagent_service.exists
  block:
    - name: "Windows: Copy agent package to remote server"
      ansible.windows.win_copy:
        src: "{{ return_download_agent.original_message.full_path }}"
        dest: "{{ remote_pkg_path }}"
        mode: "0644"

    - name: "Windows: Install agent package {{ return_download_agent.original_message.filename }}"
      ansible.windows.win_package:
        path: "{{ remote_pkg_path }}"
        creates_service: "SentinelAgent"
        arguments: "{{ '/SITE_TOKEN={{ reg_token_obj.json.data.token }} /quiet' if pkg_format == 'exe' else
          'SITE_TOKEN={{ reg_token_obj.json.data.token }} /QUIET' }}"
        register: installation_result
      when: pkg_format == "msi" or pkg_format == "exe"

    - name: "Windows: Start SentinelAgent and enable autostart"
      ansible.windows.win_service:
        name: SentinelAgent
        start_mode: auto
        state: started

    - name: "Windows: Remove agent package from target machine"
      ansible.windos.win_file:
        path: "{{ remote_pkg_path }}"
        state: absent

    - name: "Windos: Reboot after agent installation or Windows Feature removal"
      ansible.windows.win_reboot:
        post_reboot_delay: 60
      when: (installation_result.reboot_required | default(false) or win_feature_remove.reboot_required) and win_allow_reboot
